name: Tests

on:
  push:
    branches: [ dev ]
  pull_request:
    branches:
     - dev
     - main

jobs:
  test:
    name: Unit tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++

    - name: Configure
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug

    - name: Build
      run: |
        cmake --build build -j4

    - name: Run tests
      run: |
        cd build/tests
        ./wiseio_tests --gtest_output=xml:test_results.xml

    - name: Unit test summary
      if: always()
      run: |
        XML=build/tests/test_results.xml

        if [ -f "$XML" ]; then
          TOTAL=$(grep -o 'tests="[0-9]*"' "$XML" | head -1 | grep -o '[0-9]*')
          FAIL=$(grep -o 'failures="[0-9]*"' "$XML" | head -1 | grep -o '[0-9]*')
        else
          TOTAL="?"
          FAIL="?"
        fi

        STATUS="âŒ Failed"
        [ "${{ job.status }}" = "success" ] && STATUS="âœ… Passed"

        {
          echo "## ðŸ§ª WiseIO â€“ Unit Tests"
          echo ""
          echo "| Metric | Value |"
          echo "|-------|-------|"
          echo "| Status | $STATUS |"
          echo "| Total tests | $TOTAL |"
          echo "| Failures | $FAIL |"
        } >> $GITHUB_STEP_SUMMARY

  san:
    name: AddressSanitizer
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++

    - name: Configure (ASan)
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address"

    - name: Build
      run: |
        cmake --build build -j4

    - name: Run tests (ASan)
      run: |
        cd build/tests
        ./wiseio_tests

    - name: ASan summary
      if: always()
      run: |
        STATUS="âŒ Failed"
        [ "${{ job.status }}" = "success" ] && STATUS="âœ… Passed"

        {
          echo "## ðŸ§¨ AddressSanitizer"
          echo ""
          echo "- Status: **$STATUS**"
        } >> $GITHUB_STEP_SUMMARY
